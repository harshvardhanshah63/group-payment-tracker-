<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Tracker</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #6c5ce7;
            --secondary: #a29bfe;
            --dark: #2d3436;
            --light: #f5f6fa;
            --success: #00b894;
            --danger: #d63031;
            --warning: #fdcb6e;
            --info: #0984e3;
            --border-radius: 8px;
            --box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            color: var(--dark);
            line-height: 1.6;
            padding: 15px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding: 15px 20px;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }

        .app-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .app-title i {
            background: #f0f2ff;
            padding: 10px;
            border-radius: 50%;
        }

        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: var(--border-radius);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #5649c0;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: #b02b2b;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: var(--secondary);
            color: white;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #8c7ae6;
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .card:hover {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .card-header {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f2f5;
        }

        .card-title {
            font-size: 22px;
            font-weight: 700;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-title i {
            color: var(--primary);
        }

        .card-subtitle {
            font-size: 14px;
            color: #7f8c8d;
            margin-top: 5px;
        }

        .form-group {
            margin-bottom: 18px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
            font-size: 15px;
        }

        .form-control {
            width: 100%;
            padding: 14px;
            border: 2px solid #e1e5eb;
            border-radius: var(--border-radius);
            font-size: 16px;
            transition: all 0.3s ease;
            background: #f8f9fc;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(108, 92, 231, 0.2);
            background: white;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        @media (min-width: 768px) {
            .grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        .list {
            list-style: none;
            margin-top: 15px;
            border-radius: var(--border-radius);
            overflow: hidden;
            border: 2px solid #f0f2f5;
        }

        .list-item {
            padding: 14px 18px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fc;
            border-bottom: 2px solid #f0f2f5;
            transition: all 0.2s ease;
        }

        .list-item:hover {
            background: #f0f2ff;
        }

        .list-item:last-child {
            border-bottom: none;
        }

        .badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .badge-success {
            background: rgba(0, 184, 148, 0.15);
            color: var(--success);
        }

        .badge-danger {
            background: rgba(214, 48, 49, 0.15);
            color: var(--danger);
        }

        .text-right {
            text-align: right;
        }

        .text-center {
            text-align: center;
        }

        .mt-3 {
            margin-top: 15px;
        }

        .mt-4 {
            margin-top: 20px;
        }

        .mb-3 {
            margin-bottom: 15px;
        }

        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            border-radius: var(--border-radius);
            border: 2px solid #f0f2f5;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            min-width: 700px;
        }

        .table th, .table td {
            padding: 16px;
            text-align: left;
            border-bottom: 2px solid #f0f2f5;
        }

        .table th {
            background: #f8f9fc;
            font-weight: 700;
            color: #5a67d8;
            font-size: 15px;
        }

        .table tr:last-child td {
            border-bottom: none;
        }

        .table tr:hover {
            background: #f8f9ff;
        }

        .hidden {
            display: none;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 500px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        .modal-header {
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--dark);
        }

        .modal-body {
            margin-bottom: 25px;
            font-size: 17px;
            line-height: 1.6;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
        }

        .full-width {
            width: 100%;
        }

        .results-section {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .results-section.show {
            display: block;
        }

        .filter-section {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .filter-control {
            flex: 1;
            min-width: 200px;
        }

        .pdf-preview {
            background: white;
            border-radius: var(--border-radius);
            padding: 30px;
            box-shadow: var(--box-shadow);
            margin: 20px 0;
            display: none;
        }

        .pdf-preview.show {
            display: block;
            animation: slideUp 0.5s ease;
        }

        .pdf-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f2f5;
        }

        .pdf-title {
            font-size: 28px;
            color: var(--primary);
            margin-bottom: 10px;
        }

        .pdf-subtitle {
            color: #7f8c8d;
            font-size: 16px;
        }

        .pdf-section {
            margin-bottom: 30px;
        }

        .pdf-section-title {
            font-size: 20px;
            color: var(--dark);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f2f5;
        }

        .pdf-table {
            width: 100%;
            border-collapse: collapse;
        }

        .pdf-table th {
            background: #f8f9fc;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }

        .pdf-table td {
            padding: 12px;
            border-bottom: 1px solid #f0f2f5;
        }

        .pdf-footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #f0f2f5;
            color: #7f8c8d;
            font-size: 14px;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
            
            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .filter-section {
                flex-direction: column;
                gap: 10px;
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="app-title">
                <i class="fas fa-money-bill-wave"></i>
                Expense Tracker
            </div>
            <button id="resetBtn" class="btn btn-danger">
                <i class="fas fa-trash-alt"></i> Reset All
            </button>
        </div>

        <!-- Main Content Grid -->
        <div class="grid">
            <!-- Add Members Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <i class="fas fa-users"></i>
                        Add Team Members
                    </div>
                    <div class="card-subtitle">Enter the names of your trip companions</div>
                </div>
                <div class="form-group">
                    <input type="text" id="newMemberName" class="form-control" placeholder="Enter member name">
                </div>
                <button id="addMemberBtn" class="btn btn-primary full-width">
                    <i class="fas fa-user-plus"></i> Add Member
                </button>
                <div id="membersListContainer" class="mt-3 hidden">
                    <h3>Current Members:</h3>
                    <ul id="membersList" class="list"></ul>
                </div>
            </div>

            <!-- Add Expenses Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <i class="fas fa-receipt"></i>
                        Add Expenses
                    </div>
                    <div class="card-subtitle">Record who paid how much for what</div>
                </div>
                <div class="form-group">
                    <label for="payerSelect" class="form-label">Payer</label>
                    <select id="payerSelect" class="form-control" disabled>
                        <option value="">Select a member</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="amountInput" class="form-label">Amount (₹)</label>
                    <input type="number" id="amountInput" class="form-control" placeholder="Enter amount" step="0.01">
                </div>
                <div class="form-group">
                    <label for="categoryInput" class="form-label">Category</label>
                    <input type="text" id="categoryInput" class="form-control" placeholder="e.g., Food, Transport">
                </div>
                <div class="form-group">
                    <label for="notesInput" class="form-label">Notes (Optional)</label>
                    <textarea id="notesInput" class="form-control" placeholder="Add any additional notes..." rows="2"></textarea>
                </div>
                <button id="addExpenseBtn" class="btn btn-primary full-width" disabled>
                    <i class="fas fa-plus-circle"></i> Add Expense
                </button>
            </div>
        </div>

        <!-- Expense Filters -->
        <div class="card mt-3 hidden" id="expenseFilters">
            <div class="card-header">
                <div class="card-title">
                    <i class="fas fa-filter"></i>
                    Filter Expenses
                </div>
            </div>
            <div class="filter-section">
                <div class="filter-control">
                    <label for="filterCategory" class="form-label">By Category</label>
                    <select id="filterCategory" class="form-control">
                        <option value="">All Categories</option>
                    </select>
                </div>
                <div class="filter-control">
                    <label for="filterPayer" class="form-label">By Payer</label>
                    <select id="filterPayer" class="form-control">
                        <option value="">All Payers</option>
                    </select>
                </div>
                <div class="filter-control">
                    <button id="clearFiltersBtn" class="btn btn-secondary full-width" style="margin-top: 24px;">
                        <i class="fas fa-times"></i> Clear Filters
                    </button>
                </div>
            </div>
        </div>

        <!-- Expenses Table -->
        <div class="card mt-3 hidden" id="expensesTableContainer">
            <div class="card-header">
                <div class="card-title">
                    <i class="fas fa-history"></i>
                    Recorded Expenses
                </div>
            </div>
            <div class="table-responsive">
                <table class="table" id="expensesTable">
                    <thead>
                        <tr>
                            <th>Date & Time</th>
                            <th>Payer</th>
                            <th>Category</th>
                            <th class="text-right">Amount</th>
                            <th>Notes</th>
                        </tr>
                    </thead>
                    <tbody id="expensesTableBody">
                        <!-- Expenses will be inserted here by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Calculate Splits Button -->
        <div class="text-center mt-3">
            <button id="calculateSplitsBtn" class="btn btn-primary" disabled>
                <i class="fas fa-calculator"></i> Calculate Splits
            </button>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" class="results-section">
            <!-- Expense Summary -->
            <div class="card mt-3 hidden" id="expenseSummaryCard">
                <div class="card-header">
                    <div class="card-title">
                        <i class="fas fa-chart-pie"></i>
                        Expense Summary
                    </div>
                    <div class="card-subtitle">See who owes whom based on their net balance</div>
                </div>
                <div class="table-responsive">
                    <table class="table" id="balancesTable">
                        <thead>
                            <tr>
                                <th>Member</th>
                                <th class="text-right">Amount</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="balancesTableBody">
                            <!-- Balances will be inserted here by JavaScript -->
                        </tbody>
                    </table>
                </div>
                <div class="mt-3">
                    <p><span class="badge badge-success">Positive balance:</span> This person is owed money (they paid more than their share).</p>
                    <p><span class="badge badge-danger">Negative balance:</span> This person owes money (they paid less than their share).</p>
                </div>
            </div>

            <!-- Suggested Payments -->
            <div class="card mt-3 hidden" id="suggestedPaymentsCard">
                <div class="card-header">
                    <div class="card-title">
                        <i class="fas fa-exchange-alt"></i>
                        Suggested Payments to Settle
                    </div>
                    <div class="card-subtitle">These payments will clear all balances with minimum transactions</div>
                </div>
                <div class="table-responsive">
                    <table class="table" id="suggestedPaymentsTable">
                        <thead>
                            <tr>
                                <th>From</th>
                                <th>To</th>
                                <th class="text-right">Amount</th>
                            </tr>
                        </thead>
                        <tbody id="suggestedPaymentsTableBody">
                            <!-- Suggested payments will be inserted here by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- PDF Preview and Download -->
            <div class="pdf-preview" id="pdfPreview">
                <div class="pdf-header">
                    <div class="pdf-title">Expense Summary Report</div>
                    <div class="pdf-subtitle" id="pdfDate">Generated on: 26 June 2025</div>
                </div>
                
                <div class="pdf-section">
                    <div class="pdf-section-title">Expense Details</div>
                    <table class="pdf-table" id="pdfExpenseTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Payer</th>
                                <th>Category</th>
                                <th class="text-right">Amount</th>
                                <th>Notes</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- PDF expense rows will be added here -->
                        </tbody>
                    </table>
                </div>
                
                <div class="pdf-section">
                    <div class="pdf-section-title">Balance Summary</div>
                    <table class="pdf-table" id="pdfBalanceTable">
                        <thead>
                            <tr>
                                <th>Member</th>
                                <th class="text-right">Amount</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- PDF balance rows will be added here -->
                        </tbody>
                    </table>
                </div>
                
                <div class="pdf-section">
                    <div class="pdf-section-title">Suggested Payments</div>
                    <table class="pdf-table" id="pdfPaymentsTable">
                        <thead>
                            <tr>
                                <th>From</th>
                                <th>To</th>
                                <th class="text-right">Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- PDF payment rows will be added here -->
                        </tbody>
                    </table>
                </div>
                
                <div class="pdf-footer">
                    Generated by Expense Tracker - Simplifying group expenses
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons">
                <button id="downloadPdfBtn" class="btn btn-primary full-width" disabled>
                    <i class="fas fa-download"></i> Download PDF Report
                </button>
                <button id="viewPdfBtn" class="btn btn-secondary full-width" disabled>
                    <i class="fas fa-eye"></i> View PDF Preview
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global State
        let members = [];
        let expenses = [];
        let balances = [];
        let suggestedPayments = [];
        let filteredExpenses = [];

        // DOM Elements
        const newMemberNameInput = document.getElementById("newMemberName");
        const addMemberBtn = document.getElementById("addMemberBtn");
        const membersList = document.getElementById("membersList");
        const membersListContainer = document.getElementById("membersListContainer");

        const payerSelect = document.getElementById("payerSelect");
        const amountInput = document.getElementById("amountInput");
        const categoryInput = document.getElementById("categoryInput");
        const notesInput = document.getElementById("notesInput");
        const addExpenseBtn = document.getElementById("addExpenseBtn");
        const expensesTableBody = document.getElementById("expensesTableBody");
        const expensesTableContainer = document.getElementById("expensesTableContainer");

        // Filter elements
        const filterCategory = document.getElementById("filterCategory");
        const filterPayer = document.getElementById("filterPayer");
        const clearFiltersBtn = document.getElementById("clearFiltersBtn");
        const expenseFilters = document.getElementById("expenseFilters");

        const calculateSplitsBtn = document.getElementById("calculateSplitsBtn");
        const balancesTableBody = document.getElementById("balancesTableBody");
        const suggestedPaymentsTableBody = document.getElementById("suggestedPaymentsTableBody");

        const expenseSummaryCard = document.getElementById("expenseSummaryCard");
        const suggestedPaymentsCard = document.getElementById("suggestedPaymentsCard");
        const downloadPdfBtn = document.getElementById("downloadPdfBtn");
        const viewPdfBtn = document.getElementById("viewPdfBtn");
        const resultsSection = document.getElementById("resultsSection");
        const pdfPreview = document.getElementById("pdfPreview");
        const pdfDate = document.getElementById("pdfDate");

        // Reset button
        const resetBtn = document.getElementById("resetBtn");

        // Utility Functions
        const generateId = () => {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        };

        const formatDateTime = (dateString) => {
            const date = new Date(dateString);
            return date.toLocaleString("en-IN", {
                year: "numeric",
                month: "short",
                day: "numeric",
                hour: "2-digit",
                minute: "2-digit",
            });
        };

        const getCurrentDateTime = () => {
            return new Date().toISOString();
        };

        const formatDateForPDF = () => {
            const now = new Date();
            return now.toLocaleDateString('en-IN', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        };

        // Local Storage Functions
        const saveToLocalStorage = () => {
            localStorage.setItem("expenseTrackerMembers", JSON.stringify(members));
            localStorage.setItem("expenseTrackerExpenses", JSON.stringify(expenses));
        };

        const loadFromLocalStorage = () => {
            const savedMembers = localStorage.getItem("expenseTrackerMembers");
            const savedExpenses = localStorage.getItem("expenseTrackerExpenses");

            if (savedMembers) {
                members = JSON.parse(savedMembers);
            }
            if (savedExpenses) {
                expenses = JSON.parse(savedExpenses);
                expenses = expenses.map((exp) => ({
                    id: exp.id || generateId(),
                    payer: exp.payer,
                    amount: exp.amount,
                    category: exp.category,
                    notes: exp.notes || "",
                    date: exp.date || getCurrentDateTime(),
                }));
            }
        };

        // Filtering Functions
        const updateFilterOptions = () => {
            // Update category filter
            const categories = [...new Set(expenses.map((exp) => exp.category))];
            filterCategory.innerHTML = '<option value="">All Categories</option>';
            categories.forEach((category) => {
                const option = document.createElement("option");
                option.value = category;
                option.textContent = category;
                filterCategory.appendChild(option);
            });

            // Update payer filter
            const payers = [...new Set(expenses.map((exp) => exp.payer))];
            filterPayer.innerHTML = '<option value="">All Payers</option>';
            payers.forEach((payer) => {
                const option = document.createElement("option");
                option.value = payer;
                option.textContent = payer;
                filterPayer.appendChild(option);
            });

            // Show/hide filter section
            if (expenses.length > 0) {
                expenseFilters.classList.remove("hidden");
            } else {
                expenseFilters.classList.add("hidden");
            }
        };

        const applyFilters = () => {
            const categoryFilter = filterCategory.value;
            const payerFilter = filterPayer.value;

            filteredExpenses = expenses.filter((expense) => {
                const matchesCategory = !categoryFilter || expense.category === categoryFilter;
                const matchesPayer = !payerFilter || expense.payer === payerFilter;
                return matchesCategory && matchesPayer;
            });

            renderExpenses();
        };

        const clearFilters = () => {
            filterCategory.value = "";
            filterPayer.value = "";
            filteredExpenses = [...expenses];
            renderExpenses();
        };

        // Rendering Functions
        const renderMembers = () => {
            membersList.innerHTML = "";
            if (members.length === 0) {
                membersListContainer.classList.add("hidden");
            } else {
                membersListContainer.classList.remove("hidden");
                members.forEach((member) => {
                    const li = document.createElement("li");
                    li.className = "list-item";
                    li.innerHTML = `
                        <span>${member}</span>
                        <button onclick="deleteMember('${member}')" class="btn btn-danger btn-sm">
                            <i class="fas fa-trash-alt"></i> Remove
                        </button>
                    `;
                    membersList.appendChild(li);
                });
            }
            updatePayerSelect();
            updateButtonStates();
        };

        const renderExpenses = () => {
            expensesTableBody.innerHTML = "";
            const expensesToShow = filteredExpenses.length > 0 || filterCategory.value || filterPayer.value ? filteredExpenses : expenses;

            if (expensesToShow.length === 0) {
                expensesTableContainer.classList.add("hidden");
            } else {
                expensesTableContainer.classList.remove("hidden");
                const sortedExpenses = [...expensesToShow].sort((a, b) => new Date(b.date) - new Date(a.date));

                sortedExpenses.forEach((exp) => {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td>${formatDateTime(exp.date)}</td>
                        <td>${exp.payer}</td>
                        <td>${exp.category}</td>
                        <td class="text-right">₹${exp.amount.toFixed(2)}</td>
                        <td>${exp.notes || "-"}</td>
                    `;
                    expensesTableBody.appendChild(tr);
                });
            }
            updateFilterOptions();
            updateButtonStates();
        };

        const renderBalances = () => {
            balancesTableBody.innerHTML = "";
            if (balances.length === 0) {
                expenseSummaryCard.classList.add("hidden");
            } else {
                expenseSummaryCard.classList.remove("hidden");
                balances.forEach((bal) => {
                    const tr = document.createElement("tr");
                    const statusClass = bal.balance < 0 ? "badge-danger" : "badge-success";
                    const statusText = bal.balance < 0 ? "Owes" : "Is Owed";
                    tr.innerHTML = `
                        <td>${bal.name}</td>
                        <td class="text-right">₹${Math.abs(bal.balance).toFixed(2)}</td>
                        <td><span class="badge ${statusClass}">${statusText}</span></td>
                    `;
                    balancesTableBody.appendChild(tr);
                });
            }
        };

        const renderSuggestedPayments = () => {
            suggestedPaymentsTableBody.innerHTML = "";
            if (suggestedPayments.length === 0) {
                suggestedPaymentsCard.classList.add("hidden");
            } else {
                suggestedPaymentsCard.classList.remove("hidden");
                suggestedPayments.forEach((payment) => {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td>${payment.from}</td>
                        <td>${payment.to}</td>
                        <td class="text-right">₹${payment.amount.toFixed(2)}</td>
                    `;
                    suggestedPaymentsTableBody.appendChild(tr);
                });
            }
        };

        const updatePayerSelect = () => {
            payerSelect.innerHTML = '<option value="">Select a member</option>';
            if (members.length === 0) {
                payerSelect.disabled = true;
            } else {
                payerSelect.disabled = false;
                members.forEach((member) => {
                    const option = document.createElement("option");
                    option.value = member;
                    option.textContent = member;
                    payerSelect.appendChild(option);
                });
            }
        };

        const updateButtonStates = () => {
            const hasRequiredFields = payerSelect.value && amountInput.value && categoryInput.value.trim();
            addExpenseBtn.disabled = !hasRequiredFields;
            calculateSplitsBtn.disabled = !(members.length > 0 && expenses.length > 0);
            downloadPdfBtn.disabled = !(balances.length > 0 || suggestedPayments.length > 0);
            viewPdfBtn.disabled = !(balances.length > 0 || suggestedPayments.length > 0);
        };

        // Member and Expense Functions
        const addMember = () => {
            const name = newMemberNameInput.value.trim();
            if (name && !members.includes(name)) {
                members.push(name);
                newMemberNameInput.value = "";
                saveToLocalStorage();
                renderMembers();
            }
        };

        const deleteMember = (memberName) => {
            if (confirm(`Are you sure you want to remove ${memberName}? This will also delete their expenses.`)) {
                members = members.filter((member) => member !== memberName);
                expenses = expenses.filter((expense) => expense.payer !== memberName);
                saveToLocalStorage();
                renderMembers();
                renderExpenses();
                calculateSplits();
            }
        };

        const addExpense = () => {
            const payer = payerSelect.value;
            const amount = Number.parseFloat(amountInput.value);
            const category = categoryInput.value.trim();
            const notes = notesInput.value.trim();
            const date = getCurrentDateTime();

            if (payer && !isNaN(amount) && amount > 0 && category) {
                const newExpense = {
                    id: generateId(),
                    payer,
                    amount,
                    category,
                    notes,
                    date,
                };
                expenses.push(newExpense);
                payerSelect.value = "";
                amountInput.value = "";
                categoryInput.value = "";
                notesInput.value = "";
                saveToLocalStorage();
                filteredExpenses = [...expenses];
                renderExpenses();
            }
        };

        // Calculation Functions
        const calculateSplits = () => {
            if (members.length === 0) {
                balances = [];
                suggestedPayments = [];
                renderBalances();
                renderSuggestedPayments();
                resultsSection.classList.remove("show");
                return;
            }

            const totalExpenses = expenses.reduce((sum, expense) => sum + expense.amount, 0);
            const averagePerPerson = totalExpenses / members.length;

            const memberPayments = new Map();
            members.forEach((member) => memberPayments.set(member, 0));
            expenses.forEach((expense) => {
                memberPayments.set(expense.payer, (memberPayments.get(expense.payer) || 0) + expense.amount);
            });

            balances = members.map((member) => {
                const paid = memberPayments.get(member) || 0;
                const balance = paid - averagePerPerson;
                return { name: member, balance };
            });

            // Suggest direct payments
            const tempBalances = balances.map((b) => ({ ...b }));

            const debtors = tempBalances.filter((b) => b.balance < -0.01).sort((a, b) => a.balance - b.balance);
            const creditors = tempBalances.filter((b) => b.balance > 0.01).sort((a, b) => b.balance - a.balance);

            const payments = [];
            let i = 0;
            let j = 0;

            while (i < debtors.length && j < creditors.length) {
                const debtor = debtors[i];
                const creditor = creditors[j];

                const amountToPay = Math.min(Math.abs(debtor.balance), creditor.balance);

                payments.push({
                    from: debtor.name,
                    to: creditor.name,
                    amount: amountToPay,
                });

                debtor.balance += amountToPay;
                creditor.balance -= amountToPay;

                if (Math.abs(debtor.balance) < 0.01) {
                    i++;
                }
                if (Math.abs(creditor.balance) < 0.01) {
                    j++;
                }
            }
            suggestedPayments = payments;

            // Show results section
            resultsSection.classList.add("show");
            renderBalances();
            renderSuggestedPayments();
            updateButtonStates();
        };

        // PDF Functions
        const generatePDFPreview = () => {
            pdfDate.textContent = `Generated on: ${formatDateForPDF()}`;
            
            // Expense Table
            const expenseTable = document.getElementById("pdfExpenseTable");
            const expenseTableBody = expenseTable.querySelector("tbody");
            expenseTableBody.innerHTML = "";
            
            expenses.forEach(exp => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${formatDateTime(exp.date)}</td>
                    <td>${exp.payer}</td>
                    <td>${exp.category}</td>
                    <td class="text-right">₹${exp.amount.toFixed(2)}</td>
                    <td>${exp.notes || "-"}</td>
                `;
                expenseTableBody.appendChild(tr);
            });
            
            // Balance Table
            const balanceTable = document.getElementById("pdfBalanceTable");
            const balanceTableBody = balanceTable.querySelector("tbody");
            balanceTableBody.innerHTML = "";
            
            balances.forEach(bal => {
                const tr = document.createElement("tr");
                const statusClass = bal.balance < 0 ? "badge-danger" : "badge-success";
                const statusText = bal.balance < 0 ? "Owes" : "Is Owed";
                tr.innerHTML = `
                    <td>${bal.name}</td>
                    <td class="text-right">₹${Math.abs(bal.balance).toFixed(2)}</td>
                    <td><span class="badge ${statusClass}">${statusText}</span></td>
                `;
                balanceTableBody.appendChild(tr);
            });
            
            // Payments Table
            const paymentsTable = document.getElementById("pdfPaymentsTable");
            const paymentsTableBody = paymentsTable.querySelector("tbody");
            paymentsTableBody.innerHTML = "";
            
            suggestedPayments.forEach(payment => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${payment.from}</td>
                    <td>${payment.to}</td>
                    <td class="text-right">₹${payment.amount.toFixed(2)}</td>
                `;
                paymentsTableBody.appendChild(tr);
            });
            
            pdfPreview.classList.add("show");
        };

        const downloadPDF = () => {
            // Create a printable version of the PDF preview
            const printContent = document.getElementById("pdfPreview").innerHTML;
            const originalContent = document.body.innerHTML;
            
            document.body.innerHTML = printContent;
            window.print();
            
            // Restore original content
            document.body.innerHTML = originalContent;
            
            // Re-attach event listeners
            initEventListeners();
        };

        // Event Listeners
        const initEventListeners = () => {
            addMemberBtn.addEventListener("click", addMember);
            newMemberNameInput.addEventListener("keypress", (e) => {
                if (e.key === "Enter") addMember();
            });

            addExpenseBtn.addEventListener("click", addExpense);
            amountInput.addEventListener("keypress", (e) => {
                if (e.key === "Enter") addExpense();
            });
            categoryInput.addEventListener("keypress", (e) => {
                if (e.key === "Enter") addExpense();
            });

            payerSelect.addEventListener("change", updateButtonStates);
            amountInput.addEventListener("input", updateButtonStates);
            categoryInput.addEventListener("input", updateButtonStates);

            filterCategory.addEventListener("change", applyFilters);
            filterPayer.addEventListener("change", applyFilters);
            clearFiltersBtn.addEventListener("click", clearFilters);

            calculateSplitsBtn.addEventListener("click", calculateSplits);
            viewPdfBtn.addEventListener("click", generatePDFPreview);
            downloadPdfBtn.addEventListener("click", downloadPDF);
            
            resetBtn.addEventListener("click", () => {
                if (confirm("Are you sure you want to reset all data? This will delete all members and expenses.")) {
                    members = [];
                    expenses = [];
                    balances = [];
                    suggestedPayments = [];
                    filteredExpenses = [];
                    localStorage.removeItem("expenseTrackerMembers");
                    localStorage.removeItem("expenseTrackerExpenses");
                    renderMembers();
                    renderExpenses();
                    resultsSection.classList.remove("show");
                    pdfPreview.classList.remove("show");
                    clearFilters();
                }
            });
        };

        // Initialization
        const init = () => {
            loadFromLocalStorage();
            filteredExpenses = [...expenses];
            
            renderMembers();
            renderExpenses();
            
            initEventListeners();
        };

        // Make functions globally available
        window.deleteMember = deleteMember;

        // Initialize when DOM is loaded
        document.addEventListener("DOMContentLoaded", init);
    </script>
</body>
</html>
